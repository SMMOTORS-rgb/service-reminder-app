<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Reminder Sivamalai Motors</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --accent: #f59e0b;
            --bg-gradient: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-muted: #cbd5e1;
            --card-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, sans-serif;
        }

        body {
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: 50px;
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        header {
            padding: 2rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(to right, #fff, var(--text-muted));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .main-container {
            width: 95%;
            max-width: 1500px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
        }

        .stat-info h3 {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .stat-info .value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 4px;
        }

        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 2.8rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: white;
            outline: none;
            transition: var(--transition);
        }

        .search-box input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: white;
        }

        .btn-outline:hover {
            background: var(--glass-bg);
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 2rem;
            border-radius: var(--card-radius);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            min-width: 1000px;
        }

        th {
            background: rgba(255, 255, 255, 0.03);
            padding: 1.2rem;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            border-bottom: 1px solid var(--glass-border);
        }

        td {
            padding: 1.2rem;
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.95rem;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        tr.selected td {
            background: rgba(99, 102, 241, 0.15) !important;
            border-top: 1px solid var(--primary);
            border-bottom: 1px solid var(--primary);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            width: 95%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group.full {
            grid-column: span 2;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: white;
            outline: none;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
        }

        .form-group input[readonly] {
            background: rgba(255, 255, 255, 0.05);
            cursor: not-allowed;
        }

        .close-modal {
            cursor: pointer;
            color: var(--text-muted);
            transition: var(--transition);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            z-index: 10;
        }

        .close-modal:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            display: none;
            z-index: 2000;
            backdrop-filter: blur(8px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-group.full {
                grid-column: span 1;
            }

            header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            /* Mobile Table Cards */
            thead {
                display: none;
            }

            tr {
                display: block;
                margin-bottom: 1rem;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 12px;
                padding: 1rem;
                border: 1px solid var(--glass-border);
            }

            td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border: none;
                padding: 0.5rem 0;
                text-align: right;
            }

            td::before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--text-muted);
                margin-right: 1rem;
                text-align: left;
            }

            /* Stats Grid on Mobile */
            .stats-grid {
                grid-template-columns: 1fr;
            }

            /* Adjustments for embedded view */
            .main-container {
                width: 100%;
                padding: 0 10px;
            }

            table {
                min-width: 0 !important;
            }
        }

        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            z-index: 5000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .login-box {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            padding: 2rem;
            border-radius: var(--card-radius);
            border: 1px solid var(--glass-border);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        .pin-input {
            font-size: 2rem;
            letter-spacing: 0.5rem;
            text-align: center;
            width: 100%;
            padding: 1rem;
            margin: 1.5rem 0;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: white;
            outline: none;
        }

        .pin-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .clickable-card {
            cursor: pointer;
            transition: var(--transition);
        }

        .clickable-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.1);
        }

        .clickable-card.active-filter {
            border: 1px solid var(--primary);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="loginOverlay">
        <div class="login-box">
            <div class="logo" style="justify-content: center; margin-bottom: 2rem;">
                <i data-lucide="shield-check" style="width: 32px; height: 32px;"></i>
                Sivamalai Motors
            </div>
            <h3 style="color: var(--text-muted); margin-bottom: 1rem;">Enter Access PIN</h3>
            <input type="password" id="pinInput" class="pin-input" maxlength="4" placeholder="••••" autofocus>
            <button class="btn btn-primary" onclick="checkLogin()" style="width: 100%; justify-content: center;">
                Unlock System
            </button>
            <p id="loginError" style="color: #f87171; margin-top: 1rem; display: none;">Incorrect PIN</p>
        </div>
    </div>
    <header>
        <div class="logo">
            <i data-lucide="wrench"></i>
            Sivamalai Motors
        </div>
        <div style="display: flex; gap: 0.8rem; flex-wrap: wrap; justify-content: center;">
            <input type="file" id="importInput" accept=".xlsx, .xls, .csv" style="display: none;">
            <button class="btn btn-outline" onclick="document.getElementById('importInput').click()">
                <i data-lucide="upload"></i>
                Import Excel
            </button>
            <button class="btn btn-outline" id="exportBtn">
                <i data-lucide="download"></i>
                Export CSV
            </button>
        </div>
    </header>

    <main class="main-container">
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card glass-card clickable-card" onclick="applyFilter('all')" id="cardTotal">
                <div class="stat-icon"><i data-lucide="users"></i></div>
                <div class="stat-info">
                    <h3>Total Customers</h3>
                    <div class="value" id="statTotal">0</div>
                </div>
            </div>
            <div class="stat-card glass-card clickable-card" onclick="applyFilter('upcoming')" id="cardUpcoming">
                <div class="stat-icon" style="color: #fbbf24; background: rgba(245, 158, 11, 0.15);"><i
                        data-lucide="bell"></i></div>
                <div class="stat-info">
                    <h3>Upcoming Services</h3>
                    <div class="value" id="statUpcoming">0</div>
                </div>
            </div>
            <div class="stat-card glass-card clickable-card" onclick="applyFilter('overdue')" id="cardOverdue">
                <div class="stat-icon" style="color: #f87171; background: rgba(239, 68, 68, 0.15);"><i
                        data-lucide="alert-triangle"></i></div>
                <div class="stat-info">
                    <h3>Overdue</h3>
                    <div class="value" id="statOverdue">0</div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="actions-bar">
            <div class="search-box">
                <i data-lucide="search"></i>
                <input type="text" id="searchInput" placeholder="Search by name, mobile, or vehicle no...">
            </div>
            <button class="btn btn-primary" id="openModalBtn">
                <i data-lucide="plus"></i>
                Add New Reminder
            </button>
        </div>

        <!-- Table -->
        <div class="table-container glass-card">
            <table id="serviceTable">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Mobile</th>
                        <th>Model</th>
                        <th>Vehicle No</th>
                        <th>Service Date</th>
                        <th>Next Service Date</th>
                        <th>Next Service KM</th>
                        <th>Details</th>
                        <th style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </main>

    <!-- Modal Form -->
    <div class="modal" id="entryModal">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h2 id="modalTitle">New Service Record</h2>
                <div class="close-modal" id="closeModal">
                    <i data-lucide="x"></i>
                </div>
            </div>
            <form id="serviceForm">
                <input type="hidden" id="editId">
                <div class="form-grid">
                    <div class="form-group full">
                        <label>Customer Name</label>
                        <input type="text" id="custName" required>
                    </div>
                    <div class="form-group">
                        <label>Mobile Number</label>
                        <input type="tel" id="custMobile" required>
                    </div>
                    <div class="form-group">
                        <label>Vehicle Model</label>
                        <input type="text" id="vehModel" required>
                    </div>
                    <div class="form-group">
                        <label>Vehicle Number</label>
                        <input type="text" id="vehNumber" required
                            placeholder="TN 01 AB 1234 or Negative Reg (e.g., -VEH001)">
                    </div>
                    <div class="form-group">
                        <label>Current KM</label>
                        <input type="number" id="currentKM" required>
                    </div>
                    <div class="form-group">
                        <label>Service Date</label>
                        <input type="date" id="serviceDate" required>
                    </div>
                    <div class="form-group">
                        <label>Next Service Date (+3 Months)</label>
                        <input type="date" id="reminderDate" readonly>
                    </div>
                    <div class="form-group">
                        <label>Next Service KM (+3000)</label>
                        <input type="number" id="reminderKM" readonly>
                    </div>
                    <div class="form-group full">
                        <label>Service Details / Remarks</label>
                        <textarea id="serviceDetails"
                            placeholder="Enter service details, parts replaced, etc..."></textarea>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;" id="saveBtn">Save Reminder</button>
                    <button type="button" class="btn btn-outline" id="modalDeleteBtn"
                        style="flex: 1; color: #f87171; display: none;">Delete</button>
                    <button type="button" class="btn btn-outline" id="cancelBtn" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div style="font-weight: 500;">Syncing with Cloud...</div>
    </div>

    <script>
        // Data Store
        const API_URL = "https://script.google.com/macros/s/AKfycbzw7oOBoEJFhgiV1pEpbXvgo8WXb_QsVT7TW73IY7RntTBTvB-YRx86fWhsb1J31q5biA/exec"; // CAUTION: Use '/exec' for production
        let reminders = [];

        // Constants
        const SERVICE_GAP_MONTHS = 3;
        const SERVICE_GAP_KM = 3000;

        // Initialize Icons
        lucide.createIcons();

        // Login System
        const PIN = "8020";
        const loginOverlay = document.getElementById('loginOverlay');
        const pinInput = document.getElementById('pinInput');

        function checkLogin() {
            if (pinInput.value === PIN) {
                loginOverlay.style.opacity = '0';
                setTimeout(() => {
                    loginOverlay.style.display = 'none';
                }, 300);
                sessionStorage.setItem('isLoggedIn', 'true');
            } else {
                document.getElementById('loginError').style.display = 'block';
                pinInput.value = '';
                pinInput.focus();
            }
        }

        pinInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') checkLogin();
            document.getElementById('loginError').style.display = 'none';
        });

        // Check Session
        if (sessionStorage.getItem('isLoggedIn') === 'true') {
            loginOverlay.style.display = 'none';
        }

        // Elements
        const modal = document.getElementById('entryModal');
        const openModalBtn = document.getElementById('openModalBtn');
        const closeModal = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const serviceForm = document.getElementById('serviceForm');
        const tableBody = document.getElementById('tableBody');
        const searchInput = document.getElementById('searchInput');
        const exportBtn = document.getElementById('exportBtn');
        const importInput = document.getElementById('importInput');
        const modalTitle = document.getElementById('modalTitle');
        const saveBtn = document.getElementById('saveBtn');
        const modalDeleteBtn = document.getElementById('modalDeleteBtn');

        // Form Calculation Logic
        const kmInput = document.getElementById('currentKM');
        const sDateInput = document.getElementById('serviceDate');
        const rDateInput = document.getElementById('reminderDate');
        const rKMInput = document.getElementById('reminderKM');
        const detailsInput = document.getElementById('serviceDetails');

        kmInput.addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            rKMInput.value = isNaN(val) ? '' : val + SERVICE_GAP_KM;
        });

        sDateInput.addEventListener('input', (e) => {
            if (e.target.value) {
                const date = new Date(e.target.value);
                date.setMonth(date.getMonth() + SERVICE_GAP_MONTHS);
                rDateInput.value = date.toISOString().split('T')[0];
            }
        });

        function resetForm() {
            serviceForm.reset();
            document.getElementById('editId').value = '';
            modalTitle.innerText = "New Service Record";
            saveBtn.innerText = "Save Reminder";
            modalDeleteBtn.style.display = 'none';

            const today = new Date().toISOString().split('T')[0];
            sDateInput.value = today;

            const nextDate = new Date();
            nextDate.setMonth(nextDate.getMonth() + SERVICE_GAP_MONTHS);
            rDateInput.value = nextDate.toISOString().split('T')[0];
        }

        openModalBtn.onclick = () => {
            resetForm();
            modal.style.display = 'flex';
            setTimeout(() => lucide.createIcons(), 50);
        }

        const hideModal = () => {
            modal.style.display = 'none';
        }

        closeModal.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            hideModal();
        });

        cancelBtn.addEventListener('click', (e) => {
            e.preventDefault();
            hideModal();
        });

        window.onclick = (e) => {
            if (e.target == modal) hideModal();
        }

        modalDeleteBtn.onclick = () => {
            const id = document.getElementById('editId').value;
            if (id) {
                handleDelete(id);
                hideModal();
            }
        };

        // CRUD Operations
        serviceForm.onsubmit = (e) => {
            e.preventDefault();
            const editId = document.getElementById('editId').value;
            const entry = {
                name: document.getElementById('custName').value,
                mobile: document.getElementById('custMobile').value,
                model: document.getElementById('vehModel').value,
                number: document.getElementById('vehNumber').value,
                km: document.getElementById('currentKM').value,
                serviceDate: document.getElementById('serviceDate').value,
                reminderDate: document.getElementById('reminderDate').value,
                reminderKM: document.getElementById('reminderKM').value,
                details: detailsInput.value,
                updatedAt: new Date().toISOString()
            };

            if (editId) {
                const index = reminders.findIndex(r => r.id === editId);
                if (index !== -1) {
                    reminders[index] = { ...reminders[index], ...entry };
                }
            } else {
                entry.id = 'REM_' + Date.now();
                entry.createdAt = new Date().toISOString();
                reminders.unshift(entry);
            }

            saveReminders(editId ? "Updated" : "Saved");
            hideModal();
        };

        function handleEdit(id) {
            const r = reminders.find(r => r.id === id);
            if (!r) {
                showToast("Error: Record not found", "#fbbf24");
                return;
            }

            document.getElementById('editId').value = r.id;
            document.getElementById('custName').value = r.name;
            document.getElementById('custMobile').value = r.mobile;
            document.getElementById('vehModel').value = r.model;
            document.getElementById('vehNumber').value = r.number;
            document.getElementById('currentKM').value = r.km;
            document.getElementById('serviceDate').value = r.serviceDate || r.createdAt.split('T')[0];
            document.getElementById('reminderDate').value = r.reminderDate;
            document.getElementById('reminderKM').value = r.reminderKM;
            detailsInput.value = r.details || '';

            modalTitle.innerText = "Edit Service Record";
            saveBtn.innerText = "Update Reminder";
            modalDeleteBtn.style.display = 'block';
            modal.style.display = 'flex';
        }

        function handleDelete(id) {
            if (confirm('Are you sure you want to delete this record?')) {
                const initialLength = reminders.length;
                reminders = reminders.filter(r => r.id !== id);

                if (reminders.length < initialLength) {
                    saveReminders("Deleted");
                } else {
                    showToast("Error: Record not found", "#fbbf24");
                }
            }
        }

        function showToast(msg, color = 'white') {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.color = color;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        // --- API Integration ---

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        async function fetchReminders() {
            showLoading(true);
            try {
                // 'action=read' matches the GAS script logic
                const res = await fetch(API_URL + "?action=read");
                const data = await res.json();

                if (Array.isArray(data)) {
                    reminders = data.map(r => ({
                        ...r,
                        // Ensure vital fields exist
                        createdAt: r.createdAt || new Date().toISOString()
                    }));
                    renderTable();
                    updateStats();
                } else {
                    console.error("Invalid data format:", data);
                }
            } catch (err) {
                showToast("Connection Error: " + err.message, "#f87171");
                console.error(err);
            } finally {
                showLoading(false);
            }
        }

        async function saveReminders(actionType) {
            showLoading(true);
            try {
                // We send the ENTIRE array to sync (simplest method for now)
                await fetch(API_URL + "?action=sync", {
                    method: 'POST',
                    body: JSON.stringify(reminders)
                });

                renderTable(searchInput.value);
                updateStats();

                if (actionType === "Deleted") showToast("✓ Record Deleted", "#f87171");
                else if (actionType === "Updated") showToast("✓ Record Updated", "#10b981");
                else if (actionType) showToast("✓ Record Saved", "#10b981");

            } catch (err) {
                showToast("Save Failed: " + err.message, "#f87171");
            } finally {
                showLoading(false);
            }
        }

        function saveAndRefresh() {
            // Backward compatibility wrapper if needed, but we replaced calls to use saveReminders
            saveReminders("Saved");
        }

        let currentFilter = 'all';

        function applyFilter(type) {
            currentFilter = type;
            document.querySelectorAll('.clickable-card').forEach(c => c.classList.remove('active-filter'));

            if (type === 'upcoming') document.getElementById('cardUpcoming').classList.add('active-filter');
            else if (type === 'overdue') document.getElementById('cardOverdue').classList.add('active-filter');
            else document.getElementById('cardTotal').classList.add('active-filter');

            renderTable(searchInput.value);
        }

        function updateStats() {
            document.getElementById('statTotal').innerText = reminders.length;

            // Normalize dates to midnight for accurate comparison
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const thirtyDays = new Date(today);
            thirtyDays.setDate(today.getDate() + 30);

            const upcoming = reminders.filter(r => {
                if (!r.reminderDate) return false;
                const d = new Date(r.reminderDate);
                d.setHours(0, 0, 0, 0);
                return d > today && d <= thirtyDays;
            }).length;

            const overdue = reminders.filter(r => {
                if (!r.reminderDate) return false;
                const d = new Date(r.reminderDate);
                d.setHours(0, 0, 0, 0);
                return d < today;
            }).length;

            document.getElementById('statUpcoming').innerText = upcoming;
            document.getElementById('statOverdue').innerText = overdue;
        }

        let selectedId = null;

        function renderTable(filterText = '') {
            tableBody.innerHTML = '';

            // 1. Text Search Filter
            let textFiltered = reminders.filter(r =>
                (r.name || '').toLowerCase().includes(filterText.toLowerCase()) ||
                (r.mobile || '').includes(filterText) ||
                (r.number || '').toLowerCase().includes(filterText.toLowerCase())
            );

            // 2. Category Filter
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const thirtyDays = new Date(today);
            thirtyDays.setDate(today.getDate() + 30);

            let finalFiltered = textFiltered.filter(r => {
                if (currentFilter === 'all') return true;
                if (!r.reminderDate) return false;

                const d = new Date(r.reminderDate);
                d.setHours(0, 0, 0, 0);

                if (currentFilter === 'upcoming') return d > today && d <= thirtyDays;
                if (currentFilter === 'overdue') return d < today;
                return true;
            });

            finalFiltered.forEach(r => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-id', r.id);
                if (selectedId === r.id) tr.classList.add('selected');

                tr.onclick = () => {
                    document.querySelectorAll('tr').forEach(row => row.classList.remove('selected'));
                    tr.classList.add('selected');
                    selectedId = r.id;
                };

                const isOverdue = new Date(r.reminderDate) < new Date();
                const shortDetails = r.details ? (r.details.substring(0, 30) + (r.details.length > 30 ? '...' : '')) : '-';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Customer" style="font-weight: 600;">${r.name}</td>
                    <td data-label="Mobile">${r.mobile}</td>
                    <td data-label="Model">${r.model}</td>
                    <td data-label="Vehicle No"><span style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px;">${r.number}</span></td>
                    <td data-label="Service Date">${r.serviceDate || 'N/A'}</td>
                    <td data-label="Next Due" style="color: ${isOverdue ? '#f87171' : (currentFilter === 'upcoming' ? '#fbbf24' : 'inherit')}">${r.reminderDate}</td>
                    <td data-label="Next KM" style="font-weight: 600;">${r.reminderKM} KM</td>
                    <td data-label="Details" title="${r.details || ''}">${shortDetails}</td>
                    <td data-label="Actions" style="text-align: right; white-space: nowrap;">
                        <button class="edit-btn" data-id="${r.id}" style="background:none; border:none; color:var(--primary); cursor:pointer; padding:5px; margin-right: 5px;">
                            <i data-lucide="edit-3" style="width:18px;"></i>
                        </button>
                        <button class="delete-btn" data-id="${r.id}" style="background:none; border:none; color:#f87171; cursor:pointer; padding:5px;">
                            <i data-lucide="trash-2" style="width:18px;"></i>
                        </button>
                    </td>
                `;

                // Attach event listeners directly
                const editBtn = row.querySelector('.edit-btn');
                const deleteBtn = row.querySelector('.delete-btn');

                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleEdit(r.id);
                });

                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleDelete(r.id);
                });

                tableBody.appendChild(row);
            });
            lucide.createIcons();
        }

        // Keyboard Support for Physical Delete Key
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Delete' && selectedId) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                handleDelete(selectedId);
            }
        });

        searchInput.oninput = (e) => renderTable(e.target.value);

        exportBtn.onclick = () => {
            const exportData = reminders.map(r => ({
                'Customer': r.name,
                'Mobile': r.mobile,
                'Model': r.model,
                'Vehicle No': r.number,
                'Service KM': r.km,
                'Service Date': r.serviceDate,
                'Next Service Date': r.reminderDate,
                'Next Service KM': r.reminderKM,
                'Details': r.details || ''
            }));
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reminders");
            const dateStr = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Sivamalai_Motors_Service_History_${dateStr}.xlsx`);
        }

        importInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const bstr = evt.target.result;
                const wb = XLSX.read(bstr, { type: 'binary' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(ws);

                data.forEach(row => {
                    const km = parseInt(row['Current KM'] || row['KM'] || row['Service KM'] || 0);
                    const name = row['Customer Name'] || row['Customer'] || row['Name'];
                    if (!name) return;

                    const entry = {
                        id: 'REM_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: name,
                        mobile: String(row['Mobile Number'] || row['Mobile'] || row['Phone'] || ''),
                        model: row['Vehicle Model'] || row['Model'] || '',
                        number: row['Vehicle Number'] || row['Vehicle No'] || row['Number'] || '',
                        km: km,
                        details: row['Details'] || row['Remarks'] || '',
                        serviceDate: row['Service Date'] || new Date().toISOString().split('T')[0],
                        reminderDate: row['Reminder Date'] || row['Next Service Date'] || '',
                        reminderKM: row['Reminder KM'] || row['Next Service KM'] || (km + SERVICE_GAP_KM),
                        createdAt: new Date().toISOString()
                    };

                    if (!entry.reminderDate) {
                        const d = new Date(entry.serviceDate);
                        d.setMonth(d.getMonth() + SERVICE_GAP_MONTHS);
                        entry.reminderDate = d.toISOString().split('T')[0];
                    }
                    reminders.unshift(entry);
                });
                saveReminders("Imported");
                showToast(`✓ Successfully imported ${data.length} records!`, "#10b981");
                importInput.value = '';
            };
            reader.readAsBinaryString(file);
        };

        // Initial Load
        fetchReminders();
    </script>
</body>

</html>